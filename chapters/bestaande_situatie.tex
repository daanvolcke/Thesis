\chapter{Bestaande situatie}

\section{SNMP Data Retriever}
\label{snmp-data-retriever}
De SNMP Data Retriever is het stuk software dat NetworkMining zelf heeft ontwikkeld voor de SNMP bevraging van netwerkcomponenten.
Alhoewel het de bedoeling is om netwerkcomponenten te ondervragen over bijvoorbeeld hun routetabel of \gls{arptabel},
is het geen probleem om ook alle andere soorten toestellen te ondervragen. Bijvoorbeeld werkstations van werknemers of
telefoontoestellen die verbonden zijn met het netwerk. De retriever laat je toe om verschillende soorten toestellen te
definiëren en welke \glspl{oid} daarbij horen. Dit wordt verder uitgelegd bij de bespreking van de configuratie hieronder.

Bij de aanvang van de masterproef was het zo dat de retriever reeds ingezet werd voor kleine en middelgrote netwerken.
De bedoeling is echter om de nodige aanpassingen te doen zodat de retriever ook vlot kan ingezet worden voor grote netwerken,
van 1000 toestellen en meer. Het plan is om eind dit jaar de software ook te kunnen gebruiken voor het netwerk van Telenet. \todo{Mag Telenet vermeld worden?}

\todo[inline]{Samenvatting van de werking van de retriever? GET- \& GETNEXT-requests, wegschrijven van de resultaten in een DB}

\todo[inline,caption=bestaande-snmp-retriever]{Uitleg over bestaande SNMP Data Retriever. \\
Vandaag in gebruik bij NetworkMining voor kleine netwerken.
Bedoeling om te kunnen inzetten op grote netwerken zoals dat van Telenet. \\
Beschrijving huidige functionaliteit, hoe werkt de software, configuratie zie hieronder.}

\subsection{Configuratie}
\label{snmp-data-retriever-configuratie}
Er zijn drie manieren waarop de retriever kan geconfigureerd worden. De belangrijkste,
en wellicht de enige waar je als eindgebruiker mee in aanraking zal komen is het XML-configuratiebestand.
Je kunt ook een aantal opties doorgeven aan de hand van argumenten bij het oproepen van het programma.
De laatste manier is via nog een configuratiebestand: het \emph{AppConfig} bestand. De laatste twee mogelijkheden
zullen hoogstwaarschijnlijk eenmalig geconfigureerd worden als de software geïnstalleerd wordt en verder nooit meer gewijzigd worden.

\todo[inline]{3 manieren om de retriever te configureren, zie de puntjes hieronder.}

\subsubsection{XML-configuratiebestand}
Zoals gezegd is dit de belangrijkste manier om de retriever te configureren.
De twee belangrijkste dingen die je kunt configureren zijn wat voor types toestellen er zijn en de lijst van IP-adressen van die toestellen.
Een voorbeeld van een definitie van een type zie je in \cref{xmlconfig-typedefinition}.
Het toestel type heet \emph{General} en als er een toestal van dat type bevraagd wordt,
moet er een SNMP walk gedaan worden van de boomtak met \gls{oid} 1.3.6.1.2.1.1. Met die \gls{oid} komt de naam \emph{system} overeen.
Dit is dezelfde boomtak die we eerder hebben gezien in \cref{boomstructuur}.
De boomtak system is verplicht aanwezig op alle SNMP-toestellen, vandaar de naam van het toesteltype.
Het \gls{mib}-bestand waarin die tak gedefiniëerd is heet \emph{RFC1213-MIB}. Al deze gegevens vind je terug in de attributen van de SNMP walk opdracht.
Een toesteltype moet niet beperkt zijn tot een SNMP walk. Ze kan ook bestaan uit meerdere SNMP walk opdrachten,
of zelfs een SNMP GET opdracht voor een enkele \gls{oid}.

% Make a float of the code listing so it doesn't get broken up in a page break.
\begin{lstlisting}[language=XML, float=h, caption={Definitie van een toesteltype in het XML-configuratiebestand}, label=xmlconfig-typedefinition]
<deviceType name="General">
	<snmpWalk oid="1.3.6.1.2.1.1" mib="RFC1213-MIB" name="system" />
</deviceType>
\end{lstlisting}

Nadat de toesteltypes gedefiniëerd zijn kun je de IP-adressen opgeven van alle toestellen die opgevraagd moeten worden.
Bij de opsomming van de toestellen hoort natuurlijk ook hun toesteltype die we eerder gedefiniëerd hebben.
In \cref{xmlconfig-devicedefinition} zie je dat de definitie van een toestel bestaat uit drie attributen: een arbitrair gekozen naam, zijn IP-adres of hostnaam en zijn toesteltype. 

\begin{lstlisting}[language=XML, float=h, caption={Definitie van een toestel in het XML-configuratiebestand}, label=xmlconfig-devicedefinition]
<device name="atlas2a1.intec.ugent.be" ip="atlas2a1.intec.ugent.be" type="Bridge" />
\end{lstlisting}
\todo{Fix code listing breaking}

De overige opties zijn die voor een databaseconnectiestring, de communitystring, de locatie van de \gls{mib}-bestanden en de SNMP timeout waarde.
(hoelang gewacht wordt (in milliseconden) op een response na het versturen van een SNMP request)

\begin{lstlisting}[language=XML, float=h, caption={Overige opties in het XML-configuratiebestand}, label=xmlconfig-misc]
<database value="Database=snmpdb;Data Source=localhost;User Id=networkminer;Password=SomePassword;Port=3306;old syntax=yes" />
<snmpCommunity get="public" />
<MIBpath value=".\MIBs" />
<snmpTimeout value="3000" />
\end{lstlisting}


\subsubsection{Argumenten}
Bij het oproepen van de retriever kun je optioneel enkele argumenten meegeven.
De belangrijkste twee zijn \emph{inputfile} en \emph{clearresults}.
Met het eerste argument geef je de locatie mee van het XML-configuratiebestand.
Clearresults zorgt ervoor dat resultaten van een vorige retrieval gewist worden zodat je met een schone lei begint.
In \cref{retriever-argumenten} zie je een voorbeeld van hoe je deze argumenten moet gebruiken.

\begin{lstlisting}[float=h, caption={Oproepen van SNMP Data Retriever met twee argumenten}, label=retriever-argumenten]
SNMPDataRetrieval.exe "-clearresults" "-inputfile=config\snmp.xml"
\end{lstlisting}


\todo[inline, caption={Argumenten van retriever}]{
Zie ParseCommandLineAttributes():

\begin{itemize}
	\item clearresults
	
	\item noretrieve
	
	\item getdevicesfromquery
	
	\item serial
	
	\item inputfile
\end{itemize}
}

\subsubsection{AppConfig}
Het AppConfig bestand zal de eindgebruiker normaal niet mee in contact komen.
Ze bevat de mogelijkheid om het loglevel te veranderen zodat meer of minder logging informatie wordt uitgeschreven.
De databaseconfiguratiestring kan hier ook opgegeven worden, maar wordt overschreven indien dit al opgegeven is in het XML-configuratiebestand.
Na het vervangen van het loggingframework (zie \cref{vervanging-loggingframework}) komen er enkele loggingopties bij in dit bestand.
Zo kun je naast het loglevel ook extra uitvoermogelijkheden opgeven: naar een tekstbestand, naar het consolescherm, naar een databank of een combinatie.
Ook het logformaat kan je zelf aanpassen. Op al deze opties wordt dieper ingegaan in \cref{vervanging-loggingframework}.


\subsection{Databankstructuur}
\label{snmp-data-retriever-db}
Tijdens het uitvoeren van de retriever worden er een aantal tabellen aangemaakt in de opgegeven databank om de resultaten in op te slaan.


\todo[inline]{Tabellen en kolommen: results, devices en types.}